{"version":3,"file":"index.esm.js","sources":["../src/getGraphQLErrorCode.js","../src/Session.js","../src/getClient.js","../src/PageContainer.js","../src/firebaseConfig.js"],"sourcesContent":["import get from 'lodash.get';\r\n\r\nexport default function getGraphQLErrorCode (error) {\r\n  let code = get(error, 'graphQLErrors[0].extensions.code', null);\r\n  if (!code) {\r\n    code = get(error, 'networkError.result.errors[0].extensions.code', null);\r\n  }\r\n  return code;\r\n}\r\n","import * as React from 'react';\r\nimport {\r\n  createContext,\r\n  useContext,\r\n  useState,\r\n  useEffect\r\n} from 'react';\r\nimport PropTypes from 'prop-types';\r\nimport Firebase from 'firebase/app';\r\nimport 'firebase/auth';\r\n\r\nimport getGraphQLErrorCode from './getGraphQLErrorCode';\r\n\r\nconst SessionContext = createContext();\r\n\r\nfunction SessionProvider ({client, children, SessionUser, Loading, popup = true}) {\r\n  const [loaded, setLoaded] = useState(false);\r\n  const [error, setError] = useState(null);\r\n  const [user, _setUser] = useState(new SessionUser(null));\r\n\r\n  function setUser (data) {\r\n    const user = new SessionUser(data);\r\n    _setUser(user);\r\n  }\r\n\r\n\r\n  const useEffectMethod = () => {\r\n    const auth = Firebase.auth();\r\n    console.log(auth);\r\n    const unsubscribe = auth.onAuthStateChanged(async (firebase_user)=> {\r\n      console.log(firebase_user);\r\n      try {\r\n        if (firebase_user) {\r\n          const token = await firebase_user.getIdToken(true);\r\n          console.log(\"token\",token)\r\n          client.setToken(token);\r\n          console.log(SessionUser);\r\n          const user = await SessionUser.load({client, token, firebase_user});\r\n          console.log(\"user\",user)\r\n          setUser(user);\r\n        } else {\r\n          client.clearToken();\r\n          setUser(null);\r\n        }\r\n      } catch (error) {\r\n        console.log(error);\r\n        const code = getGraphQLErrorCode(error);\r\n        if (code) {\r\n          setError(code);\r\n        } else {\r\n          setError('Session error');\r\n        }\r\n      } finally {\r\n        setLoaded(true);\r\n      }\r\n    });\r\n\r\n    return ()=> {\r\n      unsubscribe();\r\n    };\r\n  }\r\n\r\n  // useEffect(useEffectMethod, []);\r\n\r\n  async function start ({email, password, provider: provider_name}) {\r\n    console.log('args', {email, password, provider: provider_name});\r\n    const auth = Firebase.auth();\r\n    const provider_method = popup ? 'signInWithPopup' : 'signInWithRedirect';\r\n    const dedicated_providers = ['Google', 'Facebook', 'Twitter', 'Github'];\r\n    const oauth_providers = ['Yahoo', 'Microsoft', 'Apple'];\r\n\r\n    function invalidMode () {\r\n      //throw new Error(`Invalid auth mode: ${provider_name}`);\r\n    }\r\n\r\n    let result;\r\n    if (provider_name.includes('Email')) {\r\n      let action;\r\n      if (provider_name === 'EmailSignin') {\r\n        action = 'signInWithEmailAndPassword';\r\n      } else if (provider_name === 'EmailSignup') {\r\n        action = 'createUserWithEmailAndPassword';\r\n      } else {\r\n        invalidMode();\r\n      }\r\n\r\n      result = await auth[action](email, password);\r\n\r\n      if (action === 'createUserWithEmailAndPassword') {\r\n        result = await auth.currentUser.sendEmailVerification();\r\n      }\r\n    } else if (dedicated_providers.includes(provider_name)) {\r\n      const Provider = Firebase.auth[`${provider_name}AuthProvider`];\r\n      const provider = new Provider();\r\n      result = await auth[provider_method](provider);\r\n    } else if (oauth_providers.includes(provider_name)) {\r\n      const domain = `${provider_name.toLowerCase()}.com`;\r\n      const provider = new Firebase.auth.OAuthProvider(domain);\r\n      result = await auth[provider_method](provider);\r\n    } else {\r\n      invalidMode();\r\n    }\r\n    useEffectMethod();\r\n    return result;\r\n  }\r\n\r\n  function end () {\r\n    return Firebase.auth().signOut();\r\n  }\r\n\r\n  function reload () {\r\n    // TODO: implement reload\r\n  }\r\n\r\n  let $body;\r\n  if (loaded) {\r\n    $body = children({user});\r\n  } else {\r\n    $body = (\r\n      <Loading\r\n        user={user}\r\n        error={error}\r\n        reload={reload}\r\n      />\r\n    );\r\n  }\r\n\r\n  return (\r\n    <SessionContext.Provider\r\n      value={{\r\n        loaded,\r\n        error,\r\n        user,\r\n        start,\r\n        reload,\r\n        end\r\n      }}\r\n    >\r\n      {$body}\r\n    </SessionContext.Provider>\r\n  );\r\n}\r\n\r\nSessionProvider.propTypes = {\r\n  children: PropTypes.func,\r\n  client: PropTypes.object,\r\n  SessionUser: PropTypes.func,\r\n  Loading: PropTypes.func,\r\n  popup: PropTypes.bool\r\n};\r\n\r\nconst {Consumer: SessionConsumer} = SessionContext;\r\n\r\nfunction useSession () {\r\n  return useContext(SessionContext);\r\n}\r\n\r\nfunction useSessionUser () {\r\n  const session = useSession();\r\n  return session.user;\r\n}\r\n\r\nexport {\r\n  SessionContext,\r\n  SessionConsumer,\r\n  SessionProvider,\r\n  useSession,\r\n  useSessionUser\r\n};\r\n","import gql from 'graphql-tag';\r\nimport {ApolloClient} from 'apollo-client';\r\nimport {setContext} from 'apollo-link-context';\r\nimport {createHttpLink} from 'apollo-link-http';\r\nimport {InMemoryCache} from 'apollo-cache-inmemory';\r\n\r\nexport default function getClient ({uri}) {\r\n  const http_link = createHttpLink({uri});\r\n\r\n  const auth_link = setContext(async (request, prev_context)=> {\r\n    const {headers = {}} = prev_context;\r\n    const token = await getToken();\r\n    if (token) {\r\n      headers.authorization = token ? `Bearer ${token}` : '';\r\n    }\r\n    return {headers};\r\n  });\r\n\r\n  const link = auth_link.concat(http_link);\r\n  const cache = new InMemoryCache();\r\n  const client = new ApolloClient({link, cache});\r\n\r\n  async function getToken () {\r\n    const query = gql`\r\n      {\r\n        token @client\r\n      }\r\n    `;\r\n    const {data} = await client.query({query});\r\n    return data.token;\r\n  }\r\n\r\n  function setToken (token) {\r\n    return client.writeData({data: {token}});\r\n  }\r\n\r\n  function clearToken () {\r\n    return setToken(null);\r\n  }\r\n\r\n  client.setToken = setToken;\r\n  client.clearToken = clearToken;\r\n\r\n  clearToken();\r\n  return client;\r\n}\r\n","import * as React from 'react';\r\nimport {\r\n  useEffect,\r\n  useState\r\n} from 'react';\r\nimport PropTypes from 'prop-types';\r\n\r\nexport default function PageContainer ({\r\n  Loading,\r\n  Error,\r\n  match,\r\n  client\r\n}) {\r\n  const {params, route} = match;\r\n  const {page: Page} = route;\r\n\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState(null);\r\n  const [data, setData] = useState(null);\r\n\r\n  useEffect(()=> {\r\n    let unmounted = false;\r\n    async function runQuery () {\r\n      if (unmounted) {\r\n        return;\r\n      }\r\n\r\n      if (!Page.query) {\r\n        setLoading(false);\r\n        return;\r\n      }\r\n\r\n      try {\r\n        const page_query = Page.query(params);\r\n        const {data} = await client.query(page_query);\r\n        setData(data);\r\n      } catch (error) {\r\n        setError(error);\r\n      } finally {\r\n        setLoading(false);\r\n      }\r\n    }\r\n\r\n    runQuery();\r\n\r\n    return ()=> {\r\n      unmounted = true;\r\n    };\r\n  }, []);\r\n\r\n  let body;\r\n  if (loading) {\r\n    body = (\r\n      <Loading/>\r\n    );\r\n  } else if (error) {\r\n    body = (\r\n      <Error error={error}/>\r\n    );\r\n  } else {\r\n    body = (\r\n      <Page\r\n        params={params}\r\n        route={route}\r\n        {...data}\r\n      />\r\n    );\r\n  }\r\n\r\n  return body;\r\n}\r\n\r\nPageContainer.propTypes = {\r\n  Loading: PropTypes.func,\r\n  Error: PropTypes.func,\r\n  match: PropTypes.object,\r\n  client: PropTypes.object\r\n};\r\n","const config = {\r\n  // Parcel requires explicit env vars\r\n  apiKey: process.env.FIREBASE_API_KEY,\r\n  authDomain: process.env.FIREBASE_AUTH_DOMAIN,\r\n  databaseURL: process.env.FIREBASE_DATABASE_URL,\r\n  projectId: process.env.FIREBASE_PROJECT_ID,\r\n  storageBucket: process.env.FIREBASE_STORAGE_BUCKET,\r\n  messagingSenderId: process.env.FIREBASE_MESSAGING_SENDER_ID,\r\n  appId: process.env.FIREBASE_APP_ID,\r\n  measurementId: process.env.FIREBASE_MEASUREMENT_ID\r\n};\r\n\r\nexport default config;\r\n"],"names":["getGraphQLErrorCode","error","code","get","SessionContext","createContext","SessionProvider","$body","client","children","SessionUser","Loading","popup","useState","loaded","setLoaded","setError","user","_setUser","setUser","data","reload","h","Provider","value","start","email","password","provider_name","provider","auth","Firebase","console","log","onAuthStateChanged","firebase_user","body","finalizer","result","recover","getIdToken","token","setToken","load","clearToken","e","then","bind","useEffectMethod","provider_method","dedicated_providers","oauth_providers","action","includes","currentUser","sendEmailVerification","domain","toLowerCase","OAuthProvider","end","signOut","propTypes","PropTypes","func","object","bool","SessionConsumer","Consumer","useSession","useContext","useSessionUser","getClient","http_link","createHttpLink","uri","link","setContext","request","prev_context","headers","query","gql","getToken","authorization","concat","cache","InMemoryCache","ApolloClient","writeData","PageContainer","Error","match","params","route","Page","page","loading","setLoading","setData","useEffect","unmounted","page_query","runQuery","config","apiKey","process","env","FIREBASE_API_KEY","authDomain","FIREBASE_AUTH_DOMAIN","databaseURL","FIREBASE_DATABASE_URL","projectId","FIREBASE_PROJECT_ID","storageBucket","FIREBASE_STORAGE_BUCKET","messagingSenderId","FIREBASE_MESSAGING_SENDER_ID","appId","FIREBASE_APP_ID","measurementId","FIREBASE_MEASUREMENT_ID"],"mappings":"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"}