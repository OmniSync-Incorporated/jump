import"babel-polyfill";import{createContext as e,useState as o,useContext as n,useEffect as r}from"react";import t from"prop-types";import a from"firebase/app";import"firebase/auth";import s from"lodash.get";import i from"graphql-tag";import{ApolloClient as c}from"apollo-client";import{setContext as l}from"apollo-link-context";import{createHttpLink as u}from"apollo-link-http";import{InMemoryCache as p}from"apollo-cache-inmemory";function d(e){let o=s(e,"graphQLErrors[0].extensions.code",null);return o||(o=s(e,"networkError.result.errors[0].extensions.code",null)),o}const f=e();function m({client:e,children:n,SessionUser:r,Loading:t,popup:s=!0}){const[i,c]=o(!1),[l,u]=o(null),[p,m]=o(new r(null));function E(e){const o=new r(e);m(o)}function g(){}let A;return A=i?n({user:p}):h(t,{user:p,error:l,reload:g}),h(f.Provider,{value:{loaded:i,error:l,user:p,start:async function({email:o,password:n,provider:t}){console.log("args",{email:o,password:n,provider:t});const i=a.auth(),l=s?"signInWithPopup":"signInWithRedirect";let p;if(t.includes("Email")){let e;"EmailSignin"===t?e="signInWithEmailAndPassword":"EmailSignup"===t&&(e="createUserWithEmailAndPassword"),p=await i[e](o,n),"createUserWithEmailAndPassword"===e&&(p=await i.currentUser.sendEmailVerification())}else if(["Google","Facebook","Twitter","Github"].includes(t)){const e=new(0,a.auth[t+"AuthProvider"]);p=await i[l](e)}else if(["Yahoo","Microsoft","Apple"].includes(t)){const e=t.toLowerCase()+".com",o=new a.auth.OAuthProvider(e);p=await i[l](o)}return(()=>{const o=a.auth();console.log(o),o.onAuthStateChanged(async o=>{console.log(o);try{if(o){const n=await o.getIdToken(!0);console.log("token",n),e.setToken(n),console.log(r);const t=await r.load({client:e,token:n,firebase_user:o});console.log("user",t),E(t)}else e.clearToken(),E(null)}catch(e){console.log(e);const o=d(e);u(o||"Session error")}finally{c(!0)}})})(),p},reload:g,end:function(){return a.auth().signOut()}}},A)}m.propTypes={children:t.func,client:t.object,SessionUser:t.func,Loading:t.func,popup:t.bool};const{Consumer:E}=f;function g(){return n(f)}function A(){return g().user}let w,I=e=>e;function S({uri:e}){const o=u({uri:e}),n=l(async(e,o)=>{const{headers:n={}}=o,r=await async function(){const e=i(w||(w=I`
      {
        token @client
      }
    `)),{data:o}=await t.query({query:e});return o.token}();return r&&(n.authorization=r?"Bearer "+r:""),{headers:n}}).concat(o),r=new p,t=new c({link:n,cache:r});function a(e){return t.writeData({data:{token:e}})}function s(){return a(null)}return t.setToken=a,t.clearToken=s,s(),t}function y({Loading:e,Error:n,match:t,client:a}){const{params:s,route:i}=t,{page:c}=i,[l,u]=o(!0),[p,d]=o(null),[f,m]=o(null);let E;return r(()=>{let e=!1;return async function(){if(!e)if(c.query)try{const e=c.query(s),{data:o}=await a.query(e);m(o)}catch(e){d(e)}finally{u(!1)}else u(!1)}(),()=>{e=!0}},[]),E=l?h(e,null):p?h(n,{error:p}):h(c,Object.assign({params:s,route:i},f)),E}y.propTypes={Loading:t.func,Error:t.func,match:t.object,client:t.object};const _={apiKey:process.env.FIREBASE_API_KEY,authDomain:process.env.FIREBASE_AUTH_DOMAIN,databaseURL:process.env.FIREBASE_DATABASE_URL,projectId:process.env.FIREBASE_PROJECT_ID,storageBucket:process.env.FIREBASE_STORAGE_BUCKET,messagingSenderId:process.env.FIREBASE_MESSAGING_SENDER_ID,appId:process.env.FIREBASE_APP_ID,measurementId:process.env.FIREBASE_MEASUREMENT_ID};export{y as PageContainer,E as SessionConsumer,f as SessionContext,m as SessionProvider,_ as firebaseConfig,S as getClient,d as getGraphQLErrorCode,g as useSession,A as useSessionUser};
//# sourceMappingURL=index.modern.js.map
